trigger:
  branches:
    include:
      - main
  paths:
    include:
      - bootstrap/tfstate/*
resources:
  - repo: self

variables:
  -group: "Azure_SP_Connection_String"
  tf_working_dir: bootstrap/tfstate
  TF_LOG: DEBUG
  TF_LOG_PATH: terraform-debug.log

stages:
  - stage: TerraformPlan
    displayName: Install, Initialize and Plan
    jobs:
      - job: Installtf
        displayName: Installtf
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: latest

          - script: |
              echo "Client ID: $(client_id)"
              echo "Tenant ID: $(tenant_id)"
            displayName: 'Check variable resolution'

          - script: |
              cd $(tf_working_dir)
              terraform init -reconfigure \
                -backend-config="resource_group_name=Chennai-DC-BCP" \
                -backend-config="storage_account_name=bcpdbstorage" \
                -backend-config="container_name=bcpstatefile" \
                -backend-config="key=Bootstrap.terraform.tfstate"
            displayName: 'TerraformInit'
            
            env:
              ARM_CLIENT_ID: $(CLIENT)
              ARM_CLIENT_SECRET: $(SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBS)
              ARM_TENANT_ID: $(TENANT)

          - script: |
              cd $(tf_working_dir)
              TF_LOG=$(TF_LOG) TF_LOG_PATH=$(TF_LOG_PATH) terraform plan -out=tfplan
            displayName: 'Terraform Plan (with logging)'

            env:
              ARM_CLIENT_ID: $(CLIENT)
              ARM_CLIENT_SECRET: $(SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBS)
              ARM_TENANT_ID: $(TENANT)

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: $(tf_working_dir)/tfplan
              artifactName: tfplan
              publishLocation: pipeline
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: $(tf_working_dir)/$(TF_LOG_PATH)
              artifactName: tfplan-debug-log
              publishLocation: pipeline
